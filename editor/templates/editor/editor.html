{% load staticfiles %}
<div id="standalone-container">
  <div id="toolbar-container">
    <span class="ql-formats">
      <select class="ql-header"></select>
    </span>
    <span class="ql-formats">
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-underline"></button>
      <button class="ql-strike"></button>
    </span>
    <span class="ql-formats">
      <select class="ql-align"></select>
    </span>
    <span class="ql-formats">
      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>
      <button class="ql-indent" value="-1"></button>
      <button class="ql-indent" value="+1"></button>
    </span>
    <span class="ql-formats">
      <select class="ql-color"></select>
      <select class="ql-background"></select>
    </span>
    <span class="ql-formats">
      <button class="ql-blockquote"></button>
    </span>
    <span class="ql-formats">
      <button class="ql-link"></button>
      <button class="ql-image"></button>
      <button class="ql-video"></button>
    </span>
    <span class="ql-formats">
      <button class="ql-clean"></button>
    </span>
  </div>
  <div id="editor-container"></div>
</div>

<script src="{% static 'js/quill.min.js' %}"></script>

<script type="text/javascript">

  // var Image = Quill.import('formats/image');
  // Image.className = 'img-fluid';
  // Quill.register(Image, true);

  let BlockEmbed = Quill.import('blots/block/embed');
  
  class PhotoSwipeBlot extends BlockEmbed {
    static create(value) {
      let node = super.create();
      node.setAttribute('alt', value.alt);
      node.setAttribute('src', value.url);
      return node;
    }
  
    static value(node) {
      return {
        alt: node.getAttribute('alt'),
        url: node.getAttribute('src')
      };
    }
  }
  PhotoSwipeBlot.blotName = 'imagephotoswipe';
  PhotoSwipeBlot.tagName = 'img';

  Quill.register(PhotoSwipeBlot);

  const quill = new Quill('#editor-container', {
    modules: {
      toolbar: '#toolbar-container'
    },
    placeholder: 'Compose ansdfdsfsdf epic...',
    theme: 'snow'
  });

  function selectLocalImage() {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.click();

    // Listen upload local image and save to server
    input.onchange = () => {
      const file = input.files[0];

      // file type is only image.
      if (/^image\//.test(file.type)) {
        saveToServer(file);
      } else {
        console.warn('You could only upload images.');
      }
    };
  }

  function saveToServer(file) {
    const fd = new FormData();
    fd.append('image', file);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/image-upload/', true);
    xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
    xhr.onload = () => {
      if (xhr.status === 200) {
        // this is callback data: url
        const data = JSON.parse(xhr.responseText);
        insertToEditor(data);
      }
    };
    xhr.send(fd);
  }

  function insertToEditor(data) {
    // push image url to rich editor.
    const range = quill.getSelection();
    quill.insertEmbed(range.index + 1, 'imagephotoswipe', {
        alt: 'Quill Cloud',
        url: `${data.link}`,
      });
    // quill.insertEmbed(range.index, 'imagephotoswipe', {
    // alt: `${data.name}`,
    // src: `${data.link}`,
    // size: `${data.width}x${data.height}` });
    // quill.pasteHTML(range.index, `<a href="${data.link}" class="img" data-size="1600x1068"><img src="${data.link}" class="img-fluid" alt="${data.name}"></a>`);
  }

  // quill editor add image handler
  quill.getModule('toolbar').addHandler('image', () => {
    selectLocalImage();
  });
  


  $(document).ready(function () {
    var content = document.getElementById('id_content');
    var qlEditor = document.getElementsByClassName('ql-editor');

    if (content.value === '') {
      // Ести поле textarea пустое, вставлет пробел 
      content.value = ' ';
    } else {
      // При редактировании поста вставляет html
      // с textarea в quill редактор
      $('.ql-editor').html(content.value);
    }

    $("#toolbar-container").stick_in_parent();

  });
  // Передает html разметку с редактора в textarea
  // при отправке формы
  var form = document.querySelector('form');
  form.onsubmit = function () {
    var content = document.getElementById('id_content');
    content.value = quill.root.innerHTML;
  };

</script>